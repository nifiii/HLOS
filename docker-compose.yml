version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: hl-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./build-output/frontend/dist:/usr/share/nginx/html:ro
      - ./ssl:/etc/nginx/ssl:ro  # SSL 证书（可选）
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - hl-network

  # Node.js 后端
  backend:
    build:
      context: .  # 项目根目录
      dockerfile: backend/Dockerfile
      target: production  # 使用生产阶段
    container_name: hl-backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANYTHINGLLM_ENDPOINT=http://anythingllm:3001
      - ANYTHINGLLM_API_KEY=${ANYTHINGLLM_API_KEY}
    depends_on:
      - anythingllm
    restart: unless-stopped
    networks:
      - hl-network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # AnythingLLM
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: hl-anythingllm
    ports:
      - "3001:3001"
    volumes:
      - ./anythingllm-storage:/app/server/storage
      - ./anythingllm-hotdir:/app/server/storage/hotdir
    environment:
      # ⚠️ 关键配置：数据持久化存储路径（容器内路径）
      - STORAGE_DIR=/app/server/storage
      - LLM_PROVIDER=gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - EMBEDDING_ENGINE=gemini
      - GEMINI_EMBEDDING_MODEL=text-embedding-004
      - VECTOR_DB=lancedb
      - AUTH_TOKEN=${ANYTHINGLLM_API_KEY}
      - SERVER_PORT=3001
      # 优化 2核4G 服务器配置
      - CHUNK_SIZE=800
      - CHUNK_OVERLAP=150
      - MAX_CONCURRENT_CHUNKS=2
    restart: unless-stopped
    networks:
      - hl-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

networks:
  hl-network:
    driver: bridge
