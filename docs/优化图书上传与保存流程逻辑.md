## 第一阶段：版本备份与环境清理

1. **Git Tag**：执行 `git tag -a v1.3.0-pre-cleanup -m "清理重构前的备份"`。
2. **移除 AnythingLLM**：
   * 物理删除 `backend/src/routes/anythingllm.ts`。
   * 从 `saveBook.ts`、`saveScannedItem.ts`、`courseware.ts` 中**彻底删除**与 AnythingLLM 索引、推送相关的代码块。
   * 修改 `databaseService.ts` 和 `fileStorage.ts`，移除 `anythingLlmDocId` 字段。

## 第二阶段：优化 AI 服务 (doubaoService.ts)

1. **保持元数据逻辑**：`analyzeMetadataWithDoubao` 函数保持不变，继续使用前 8000 字快速获取 JSON。
2. **增强 Markdown 转化**：
   * 修改 `convertToMarkdownWithDoubao` 函数：
     * 移除 30,000 字的硬编码限制。
     * 改为接收尽可能长的 `contentText`（例如前 100,000 字，或根据模型上限动态调整）。
     * 提示词保持为：要求生成符合标准 Obsidian 范式的结构化文档。

## 第三阶段：重构图书上传流 (upload-book.ts)

1. **一次提取**：继续使用 `parsePDF` 提取全文 `contentText`。
2. **并行处理**：
   * **任务 A (元数据)**：调用 `analyzeMetadataWithDoubao`（快速返回）。
   * **任务 B (Markdown)**：调用 `convertToMarkdownWithDoubao`（全量转化）。
3. **临时持久化**：
   * 将生成的全量 Markdown 存入 `uploads/temp/[id].md`。
4. **响应前端**：返回元数据 JSON。**元数据获取和处理逻辑与之前完全一致**。

## 第四阶段：重构图书保存流 (saveBook.ts)

1. **删除冗余操作**：
   * **彻底删除** 异步任务中重新调用 `parsePDF` 的代码。
   * **彻底删除** 异步任务中重新调用 LLM 转换的代码。
2. **物理移动**：
   * 直接从 `uploads/temp/[id].md` 读取已生成的 Markdown。
   * 调用 `saveBookMarkdown` 按照存储策略（用户名/学科）将其保存到正式的 Obsidian 目录。
3. **索引更新**：
   * 在 SQLite 中将书籍状态标记为 `completed`。

## 第五阶段：验证

1. **性能**：确认 `save-book` 接口不再有耗时的 PDF 解析操作，点击保存后秒回。
2. **完整性**：检查生成的 .md 文件，确认其内容比之前更完整且符合 Obsidian 范式。
3. **代码整洁度**：确认全局已无 `AnythingLLM` 相关的残留代码。
