# 图书存储与转换流程重构计划

经过分析，我们发现当前流程中 `upload-book.ts` 和 `saveBook.ts` 的职责划分不清，导致了元数据确认前的过早处理和重复计算。我们将按照以下步骤重构，确保文件存储、封面提取和 Markdown 转换逻辑正确执行。

## 1. 优化上传与预览 (`upload-book.ts`)
*   **目标**：仅负责文件接收、初步解析（提取元数据和封面）以供前端预览，**不做持久化存储或重型转换**。
*   **修改点**：
    *   移除 `upload-book.ts` 中所有的后台 Markdown 转换代码（即删除 `convertToMarkdown` 的调用）。
    *   移除将文件移动到 `data/originals/books` 的逻辑（如果存在），仅保留文件在临时目录或内存中，或仅生成临时预览路径。
    *   确保封面图片生成并返回临时 URL。

## 2. 重构最终保存 (`saveBook.ts`)
*   **目标**：作为图书入库的唯一入口，接收用户确认后的元数据，执行所有持久化操作。
*   **修改点**：
    *   **接收参数**：更新接口以接收前端传递的 `metadata`（包含确认后的书名、作者、标签等）和 `tempFilePath`（临时文件路径）或重新上传的文件流。
    *   **文件归档**：
        *   将原始 PDF/EPUB 文件从临时位置移动到 `data/originals/books/{ownerId}/`。
        *   将封面图片从临时位置移动到 `data/covers/` 或保留在 `uploads/covers/` 并更新数据库引用。
    *   **内容转换**：
        *   在此处调用 `llmService.convertToMarkdown(content)`。
        *   将生成的 Markdown 保存到 `data/obsidian/Books/{category}/{title}.md`。
    *   **数据库/索引更新**：保存元数据到 `books.json` 数据库，并触发 AnythingLLM 索引（如果需要）。

## 3. 增强文件服务 (`fileStorage.ts` & `imageService.ts`)
*   **验证**：检查 `saveBookFile` 和 `saveObsidianMarkdown` 方法，确保它们能自动创建不存在的目录（如按学科/分类的子目录）。
*   **封面处理**：确认 `extractCoverImage` 生成的图片路径是可访问的，且在保存图书时被正确关联。

## 4. 执行步骤
1.  **修改 `backend/src/routes/upload-book.ts`**：清理后台任务。
2.  **重写 `backend/src/routes/saveBook.ts`**：实现完整的“接收-转换-存储”逻辑。
3.  **验证**：通过上传一本新书，检查原始文件、Markdown 文件和封面图片是否均出现在预期目录中。

---
**确认后将执行代码修改。**