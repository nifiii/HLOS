# 修复后端服务日志报错方案

## 1. 根因分析

### 1.1 数据库查询报错 (`SQLITE_ERROR: no such column: "shared"`)

* **现象**：在调用 `/api/books` 或 `/api/scanned-items` 时，后端日志显示 `SqliteError: no such column: "shared"`。

* **根因**：在 [fileStorage.ts](file:///d:/devops/HL-os/backend/src/services/fileStorage.ts) 的 `queryMetadata` 函数中，SQL 查询语句使用了双引号 `"shared"`。在 SQLite 中，双引号用于标识符（如列名），而单引号用于字符串常量。由于数据库表中没有名为 `shared` 的列，SQLite 将其视为不存在的列而报错。

### 1.2 图书保存失败 (`❌ 临时文件不存在: /uploads/temp/...`)

* **现象**：在调用 `/api/save-book` 时，日志显示临时文件不存在，导致保存失败。

* **根因**：在 [saveBook.ts](file:///d:/devops/HL-os/backend/src/routes/saveBook.ts) 中，路径解析逻辑存在缺陷。在 Linux 环境下，以 `/` 开头的路径（如 `/uploads/temp/...`）被 `path.isAbsolute()` 判定为绝对路径，导致程序尝试从系统根目录访问文件，而非从项目根目录访问。

***

## 2. 修复步骤

### 2.1 修复数据库查询 SQL 语法

* 修改 [fileStorage.ts](file:///d:/devops/HL-os/backend/src/services/fileStorage.ts) 中的 `queryMetadata` 函数。

* 将 SQL 语句中的 `"shared"` 修改为 `'shared'`。

### 2.2 修复图书保存路径解析

* 修改 [saveBook.ts](file:///d:/devops/HL-os/backend/src/routes/saveBook.ts) 中的路径拼接逻辑。

* 确保临时文件路径始终相对于项目根目录（`process.cwd()`）进行解析，忽略其是否以 `/` 开头。

***

## 3. 验证方案

### 3.1 数据库查询验证

* 调用 `/api/books` 接口，观察日志是否不再出现 `SqliteError`。

* 确认返回的数据包含 `ownerId` 为 `'shared'` 的记录。

### 3.2 图书保存验证

* 重新上传并保存一本图书。

* 观察日志中 `[saveBook] [1/5] 验证临时文件` 是否指向正确的绝对路径（如 `/opt/hl-os/backend/uploads/temp/...`）。

* 确认图书能够成功保存到数据库和文件系统中。

***

## 4. 风险评估与回滚

* **风险**：修改 SQL 语法和路径解析属于基础逻辑改动，需确保不会影响其他依赖这些路径的功能。

* **回滚**：若修复后出现新问题，可还原 [fileStorage.ts](file:///d:/devops/HL-os/backend/src/services/fileStorage.ts) 和 [saveBook.ts](file:///d:/devops/HL-os/backend/src/routes/saveBook.ts) 到先前版本。
